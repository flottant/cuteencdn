"use strict";function _instanceof(left,right){return null!=right&&"undefined"!=typeof Symbol&&right[Symbol.hasInstance]?!!right[Symbol.hasInstance](left):left instanceof right}function _classCallCheck(instance,Constructor){if(!_instanceof(instance,Constructor))throw new TypeError("Cannot call a class as a function")}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Constructor}var Util={leftDistance:function(el){for(var left=el.offsetLeft;el.offsetParent;)left+=(el=el.offsetParent).offsetLeft;return left-(document.body.scrollLeft+document.documentElement.scrollLeft)},timeFormat:function(time){var tempMin=parseInt(time/60),tempSec=parseInt(time%60);return(tempMin<10?"0"+tempMin:tempMin)+":"+(tempSec<10?"0"+tempSec:tempSec)},percentFormat:function(percent){return(100*percent).toFixed(2)+"%"},ajax:function(option){option.beforeSend&&option.beforeSend();var xhr=new XMLHttpRequest;xhr.onreadystatechange=function(){4===xhr.readyState&&(xhr.status>=200&&xhr.status<300?option.success&&option.success(xhr.responseText):option.fail&&option.fail(xhr.status))},xhr.open("GET",option.url),xhr.send(null)}},instance=!1,baseUrl=Config.themeUrl+"/inc/music.php",skPlayer=function(){function skPlayer(option){var _this=this;if(_classCallCheck(this,skPlayer),instance)return console.error("SKPlayer只能存在一个实例！"),Object.create(null);instance=!0;var defaultOption={element:document.getElementById("musicPop"),mobileElement:document.getElementById("musicMobileBox"),autoplay:!1,mode:"listloop",listshow:!0};for(var defaultKey in defaultOption)option.hasOwnProperty(defaultKey)||(option[defaultKey]=defaultOption[defaultKey]);if(this.option=option,!(this.option.music&&this.option.music.type&&this.option.music.source))return console.error("请正确配置对象！"),Object.create(null);this.type=this.option.music.type,this.music=this.option.music.source,this.isMobile=/mobile/i.test(window.navigator.userAgent),this.toggle=this.toggle.bind(this),this.toggleList=this.toggleList.bind(this),this.toggleMute=this.toggleMute.bind(this),this.switchMode=this.switchMode.bind(this),this.root=this.isMobile?this.option.mobileElement:this.option.element,"file"===this.type?(this.root.innerHTML=this.template(),this.init(),this.bind()):"cloud"===this.type&&(this.root.innerHTML='<p class="music-tip-loading">LOADING</p>',Util.ajax({url:baseUrl+"?type=collect&media="+this.media+"&id="+this.music,beforeSend:function(){console.log("SKPlayer正在努力的拉取歌单 ...")},success:function(data){console.log("歌单拉取成功！"),_this.music=JSON.parse(data),_this.root.innerHTML=_this.template(),_this.init(),_this.bind()},fail:function(status){console.error("歌单拉取失败！ 错误码："+status)}}))}return _createClass(skPlayer,[{key:"template",value:function(){var html=`\n            <audio class="music-source" src="${"file"===this.type?this.music[0].src:""}" preload="auto" crossOrigin="anonymous"></audio>\n            <div class="music-picture">\n                <img class="music-cover" src="${this.music[0].cover}" alt="">\n                <div class="controls d-inline-flex align-items-center">\n            <span class="music-prev-btn d-inline-flex rounded-circle mr-1" onclick="player.prev();">\n                <svg class="icon text-secondary m-2" aria-hidden="true"><use xlink:href="#prev"></use></svg>\n            </span>\n                <span class="music-play-btn d-inline-flex rounded-circle">\n                <svg class="icon icon-20 text-secondary" aria-hidden="true"><use id="play-btn-icon" xlink:href="#bofang"></use></svg>\n            </span>\n                <span class="music-next-btn d-inline-flex rounded-circle ml-1" onclick="player.next();">\n                <svg class="icon text-secondary m-2" aria-hidden="true"><use xlink:href="#next"></use></svg>\n            </span>\n            </div>\n            </div>\n            <div class="music-control">\n                <p class="music-name">${this.music[0].name}</p>\n                <p class="music-author">${this.music[0].author}</p>\n                <div class="music-percent">\n                    <div class="music-line-loading"></div>\n                    <div class="music-line"></div>\n                </div>\n                <p class="music-time">\n                    <span class="music-cur">00:00</span>/<span class="music-total">00:00</span>\n                </p>\n                <div class="music-volume" style="${this.isMobile?"display:none;":""}">\n                    <i class="music-icon"></i>\n                    <div class="music-percent">\n                        <div class="music-line"></div>\n                    </div>\n                </div>\n                <div class="music-list-switch">\n                    <i class="music-list-icon"></i>\n                </div>\n                <i class="${"singleloop"===this.option.mode?"music-mode music-mode-loop":"music-mode"}"></i>\n            </div>\n            <ul class="music-list">\n        `;for(var index in this.music)html+=`\n                <li data-index="${index}">\n                    <i class="music-list-sign"></i>\n                    <span class="music-list-index">${parseInt(index)+1}</span>\n                    <span class="music-list-name" title="${this.music[index].name}">${this.music[index].name}</span>\n                    <span class="music-list-author" title="${this.music[index].author}">${this.music[index].author}</span>\n                </li>\n            `;return html+="</ul>"}},{key:"init",value:function(){var _this2=this;this.dom={cover:this.root.querySelector(".music-cover"),playbutton:this.root.querySelector(".music-play-btn"),name:this.root.querySelector(".music-name"),author:this.root.querySelector(".music-author"),timeline_total:this.root.querySelector(".music-percent"),timeline_loaded:this.root.querySelector(".music-line-loading"),timeline_played:this.root.querySelector(".music-percent .music-line"),timetext_total:this.root.querySelector(".music-total"),timetext_played:this.root.querySelector(".music-cur"),volumebutton:this.root.querySelector(".music-icon"),volumeline_total:this.root.querySelector(".music-volume .music-percent"),volumeline_value:this.root.querySelector(".music-volume .music-line"),switchbutton:this.root.querySelector(".music-list-switch"),modebutton:this.root.querySelector(".music-mode"),musiclist:this.root.querySelector(".music-list"),musicitem:this.root.querySelectorAll(".music-list li")},this.audio=this.root.querySelector(".music-source"),this.option.listshow&&(this.root.className="music-list-on"),"singleloop"===this.option.mode&&(this.audio.loop=!0),this.dom.musicitem[0].className="music-curMusic","cloud"===this.type&&Util.ajax({url:baseUrl+"?type=song&media="+this.media+"&id="+this.music[0].song_id,beforeSend:function(){console.log("SKPlayer正在努力的拉取歌曲 ...")},success:function(data){var url=JSON.parse(data).url;null!==url?(console.log("歌曲拉取成功！"),_this2.audio.src=url):(console.log("歌曲拉取失败！ 资源无效！"),1!==_this2.music.length&&_this2.next())},fail:function(status){console.error("歌曲拉取失败！ 错误码："+status)}})}},{key:"bind",value:function(){var _this3=this;this.updateLine=function(){var percent=_this3.audio.buffered.length?_this3.audio.buffered.end(_this3.audio.buffered.length-1)/_this3.audio.duration:0;_this3.dom.timeline_loaded.style.width=Util.percentFormat(percent)},this.audio.addEventListener("durationchange",function(e){_this3.dom.timetext_total.innerHTML=Util.timeFormat(_this3.audio.duration),_this3.updateLine()}),this.audio.addEventListener("progress",function(e){_this3.updateLine()}),this.audio.addEventListener("canplay",function(e){_this3.option.autoplay&&!_this3.isMobile&&_this3.play()}),this.audio.addEventListener("timeupdate",function(e){var percent=_this3.audio.currentTime/_this3.audio.duration;_this3.dom.timeline_played.style.width=Util.percentFormat(percent),_this3.dom.timetext_played.innerHTML=Util.timeFormat(_this3.audio.currentTime)}),this.audio.addEventListener("seeked",function(e){_this3.play()}),this.audio.addEventListener("ended",function(e){_this3.next()}),this.dom.playbutton.addEventListener("click",this.toggle),this.dom.switchbutton.addEventListener("click",this.toggleList),this.isMobile||this.dom.volumebutton.addEventListener("click",this.toggleMute),this.dom.modebutton.addEventListener("click",this.switchMode),this.dom.musiclist.addEventListener("click",function(e){var target,index;if(Cuteen.stopPropagation(),"LI"===e.target.tagName.toUpperCase())target=e.target;else{if("LI"!==e.target.parentElement.tagName.toUpperCase())return;target=e.target.parentElement}(index=parseInt(target.getAttribute("data-index")))===parseInt(_this3.dom.musiclist.querySelector(".music-curMusic").getAttribute("data-index"))?_this3.play():_this3.switchMusic(index+1)}),this.dom.timeline_total.addEventListener("click",function(event){var percent=((event||window.event).clientX-Util.leftDistance(_this3.dom.timeline_total))/_this3.dom.timeline_total.clientWidth;isNaN(_this3.audio.duration)||(_this3.dom.timeline_played.style.width=Util.percentFormat(percent),_this3.dom.timetext_played.innerHTML=Util.timeFormat(percent*_this3.audio.duration),_this3.audio.currentTime=percent*_this3.audio.duration)}),this.isMobile||this.dom.volumeline_total.addEventListener("click",function(event){var percent=((event||window.event).clientX-Util.leftDistance(_this3.dom.volumeline_total))/_this3.dom.volumeline_total.clientWidth;_this3.dom.volumeline_value.style.width=Util.percentFormat(percent),_this3.audio.volume=percent,_this3.audio.muted&&_this3.toggleMute()})}},{key:"prev",value:function(){Cuteen.stopPropagation();var index=parseInt(this.dom.musiclist.querySelector(".music-curMusic").getAttribute("data-index"));0===index?1===this.music.length?this.play():this.switchMusic(this.music.length-1+1):this.switchMusic(index-1+1)}},{key:"next",value:function(){Cuteen.stopPropagation();var index=parseInt(this.dom.musiclist.querySelector(".music-curMusic").getAttribute("data-index"));index===this.music.length-1?1===this.music.length?this.play():this.switchMusic(1):this.switchMusic(index+1+1)}},{key:"switchMusic",value:function(index){var _this4=this;"number"==typeof index?(index-=1)<0||index>=this.music.length?console.error("请输入正确的歌曲序号！"):index!==this.dom.musiclist.querySelector(".music-curMusic").getAttribute("data-index")?(this.dom.musiclist.querySelector(".music-curMusic").classList.remove("music-curMusic"),this.dom.musicitem[index].classList.add("music-curMusic"),this.dom.name.innerHTML=this.music[index].name,this.dom.author.innerHTML=this.music[index].author,this.dom.cover.src=this.music[index].cover,"file"===this.type?(this.audio.src=this.music[index].src,this.play()):"cloud"===this.type&&Util.ajax({url:baseUrl+"?type=song&media="+this.media+"&id="+this.music[index].song_id,beforeSend:function(){console.log("SKPlayer正在努力的拉取歌曲 ...")},success:function(data){var url=JSON.parse(data).url;null!==url?(console.log("歌曲拉取成功！"),_this4.audio.src=url,_this4.play()):(console.log("歌曲拉取失败！ 资源无效！"),1!==_this4.music.length&&_this4.next())},fail:function(status){console.error("歌曲拉取失败！ 错误码："+status)}})):this.play():console.error("请输入正确的歌曲序号！")}},{key:"play",value:function(){Cuteen.stopPropagation(),this.audio.paused&&(this.audio.play(),document.getElementById("play-btn-icon").setAttribute("xlink:href","#pause"),document.getElementById("musicSvg").classList.add("on"),this.dom.cover.classList.add("music-pause"))}},{key:"pause",value:function(){Cuteen.stopPropagation(),this.audio.paused||(this.audio.pause(),document.getElementById("play-btn-icon").setAttribute("xlink:href","#bofang"),this.dom.cover.classList.remove("music-pause"),document.getElementById("musicSvg").classList.remove("on"))}},{key:"toggle",value:function(){this.audio.paused?this.play():this.pause()}},{key:"toggleList",value:function(){this.root.classList.contains("music-list-on")?this.root.classList.remove("music-list-on"):this.root.classList.add("music-list-on")}},{key:"toggleMute",value:function(){this.audio.muted?(this.audio.muted=!1,this.dom.volumebutton.classList.remove("music-quiet"),this.dom.volumeline_value.style.width=Util.percentFormat(this.audio.volume)):(this.audio.muted=!0,this.dom.volumebutton.classList.add("music-quiet"),this.dom.volumeline_value.style.width="0%")}},{key:"switchMode",value:function(){this.audio.loop?(this.audio.loop=!1,this.dom.modebutton.classList.remove("music-mode-loop")):(this.audio.loop=!0,this.dom.modebutton.classList.add("music-mode-loop"))}},{key:"destroy",value:function(){for(var prop in instance=!1,this.audio.pause(),this.root.innerHTML="",this)delete this[prop];console.log("该实例已销毁，可重新配置 ...")}}]),skPlayer}(),player=new skPlayer({autoplay:!1,listshow:!1,mode:"listloop",music:{type:"cloud",source:Config.musicId,media:Config.musicMedia}});